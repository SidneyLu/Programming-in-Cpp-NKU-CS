# 南开大学 高级语言程序设计 Lecture 12

## 一、并发 Concurrent
### 1. 概念
在使用PC时，我们对“多任务并行”已经习以为常。然而，直到21世纪初，绝大多数计算机都用的时单核处理器，操作系统通过在多个任务间快速切换来营造它们“并发”的假象。计算机先完成每个任务的一小部分再切换到下一个任务，这样进度条不会令人焦急地卡在原地不动。

值得一提的是，我们提出**并发（Concurrent）** 的概念，是相对于**顺序（Sequential）** 而言的，顺序是指直到一个任务彻底完成下一个才开始，而并发是指启动后它们都会取得进展却未必同时执行——由于硬件性能、设计以及程序设计的限制。**并行（in-Parallel）** 则是真正意义上的同时执行。从这个意义上说，并行性是并发性的一个子集。

理解并发、并行两个概念后，你不难推测出何为**高性能并行计算**和**高并发**，以及两种任务场景的差别。当然，今日的数据中心不难实现二者的兼顾以及卓越的性能。就连今日的消费级设备，也越发看重并发、并行性能——例如说多核CPU的推广（多核、大小核、超线程、异构），应用程序（游戏、创作软件、计算软件）的CPU、GPU优化，以及网络的收发、传输调度机制（Wifi6引入的MU-MIMO以及蜂窝移动网络中的相关技术）。

### 2. 支持
C++通过语言和标准库来支持并发性，在程序中并发的是**执行线程**，根据C++标准，一个执行线程是程序中的第一控制流，包括对特定顶层函数的初始调用，并递归包括线程后执行的每个函数调用。程序可以有多个线程，每个线程都有自己的函数调用栈和程序计数器，允许它与其他线程并发执行。给定程序中的所有线程可以共享整个应用程序的资源，例如内存、显存、文件，这种能力称为**多线程处理**。

当线程共享可修改的数据时，必须确保它们不会破坏这些数据，这就是**线程安全**。保障方法：
* 不可变数据
* 互斥
* 原子线程
* 线程局部存储

**C++并发特性的完善**

* 在 C++11 之前，C++ 多线程库都是一些非标准的、平台特有的扩展。

* C++11 引入了标准化多线程处理，提供了称为互斥体（mutex）和锁（lock）的低级线程同步基元。

* C++14 则增加了共享互斥体和共享锁。

* C++17 增加了 69 个并行标准库算法。

* C++20 增加了更高级的线程同步能力（闭锁、栅栏和信号量）

引入语言原生并发特性的目的是简化并发编程、避免常见错误、使程序更容易维护。

## 二、异步 Asynchronous
你在安装Visual Studio的时候，有没有留意安装器的这个选项？
* **Node.js 开发**

    使用Node.js（一个由异步事件驱动的JavaScript运行时）生成可缩放的网络应用程序

我们随处可见的可交互网站（非静态页面）其实都是网络（Web）应用程序，JavaScript是一门在Web开发中广泛使用的编程语言，Node.js则是一个JavaScript运行环境。

**但异步是什么？**
异步是一种非阻塞的编程范式，核心是任务发起后不阻塞当前执行流，而是继续执行其他逻辑，待任务完成后通过特定机制（如回调、事件通知）获取结果，以此解决 “耗时操作（如网络请求、磁盘读写）导致 CPU 闲置” 的问题。

现代程序中，I/O 操作的耗时远大于 CPU 计算（例如：一次网络请求可能耗时毫秒级，而 CPU 执行指令仅需纳秒级）。异步的价值正是利用 “I/O 处理的间隙” 让 CPU 执行其他逻辑，避免 “等待 I/O 时 CPU 空转”，从而提升系统整体吞吐量（比如单线程通过异步可同时处理成百上千个网络请求）**为了直观地感受耗时可以去看看打游戏时的网络延迟、自己电脑的内存延迟、CPU缓存延迟以及CPU主频**

因而**异步**是**多线程/多进程**以外另一种实现并发的手段。比方说一任务都在本机进行，我们会用到多线程；涉及到本机与其他设备通讯时，我们会用到异步。当然二者不是没有交叉，例如我们联网触发的一个异步事件，很有可能服务器端和我们本地都会调用到多个线程——多线程下载即是如此。

**C++异步支持的完善**

* C++11 future/promise
* C++17 async
* C++20 coroutine

## 三、协程 Coroutine
协程是我们介绍的C++20四大特性中的最后一个（前三个分别是范围、概念、模块）。它是一种可以暂停执行并在以后恢复的函数，编译器会自动生成代码，帮助你暂停一个协程，并将控制权返回给调用者，并在以后恢复它的执行。协程使我们能以简单的顺序编码风格进行并发编程。为了好学会、少犯错和程序的高效，一般开发者都会使用高级的协程支持库。

有很多大型企业都会有高度自定义的C++库、框架以更好适配自己的业务场景——包含用户服务、性能、维护、专利等多重考量。例如说FaceBook的folly。

如果有机会进入知名企业的C++开发岗实习或任职，你对现代C++的理解一定会得到前所未有的提升，当然那不是这门课上你要操心的。总之，Good Luck！